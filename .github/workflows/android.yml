name: Build TWA APK (from PWA)

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main

env:
  # Ensure CI flags are visible to bubblewrap during the same step
  CI: "1"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      # --- Install JDK 17 (ensure bubblewrap detects local JDK) ---
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # --- Install Node & Bubblewrap ---
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Bubblewrap CLI
        run: npm install -g @bubblewrap/cli

      # --- Restore keystore (p12) from GitHub Secret ---
      - name: Restore keystore (p12)
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "KEYSTORE_BASE64 secret is not set - aborting"; exit 1
          fi
          echo "$KEYSTORE_BASE64" | base64 --decode > upload-keystore.p12
          ls -lh upload-keystore.p12

      # --- (optional) bump version script if you keep it in repo ---
      - name: Bump version (optional)
        if: test -f scripts/bump-version.sh
        run: |
          chmod +x scripts/bump-version.sh
          ./scripts/bump-version.sh

      # --- Bubblewrap init (non-interactive, skip install checks) ---
      # Important: --skipInstall prevents bubblewrap from prompting to install JDK/SDK
      - name: Bubblewrap init (non-interactive)
        env:
          BUBBLEWRAP_NO_PROMPT: "true"
          BUBBLEWRAP_FORCE_NO_JDK: "true"
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          set -e
          bubblewrap init \
            --manifest=https://powertech0417.github.io/Cv_ap/manifest.json \
            --skipPwaDisplayModeCheck \
            --use-notification-delegation \
            --nonInteractive \
            --skipInstall \
            --signingKey=upload-keystore.p12 \
            --storePassword="$KEYSTORE_PASSWORD" \
            --keyAlias="$KEY_ALIAS" \
            --keyPassword="$KEY_PASSWORD" || echo "bubblewrap init completed or already initialized"

      # --- Build TWA APK (non-interactive) ---
      - name: Bubblewrap build (non-interactive)
        env:
          BUBBLEWRAP_NO_PROMPT: "true"
          BUBBLEWRAP_FORCE_NO_JDK: "true"
        run: |
          set -e
          # Prefer bubblewrap build; if it fails and gradlew exists, try gradle assemble
          bubblewrap build --nonInteractive --skipInstall || true
          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            ./gradlew assembleRelease --warning-mode all || true
          fi

      # --- Collect APK artifact(s) ---
      - name: Find generated APK(s)
        run: |
          echo "Searching common output locations..."
          find . -type f -name "*release*.apk" -print > apk_list.txt || true
          cat apk_list.txt || true

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cv-app-apks
          path: |
            android/app-release-signed.apk
            android/app-release.apk
            android/app/build/outputs/**/*.apk
            ./app/build/outputs/**/*.apk
            ./build/**/*.apk
            ./android/**/*.apk
            apk_list.txt

      # --- Optional: notify (telegram, slack, etc.) ---
      # Add your notify step here if desired
