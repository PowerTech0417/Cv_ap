name: Build-TWA-APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 下载你的 Repo 文件
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 生成 keystore
      - name: Decode Keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore

      # 3. 安装 JDK 17
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # 4. 安装 Node + Bubblewrap
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Bubblewrap
        run: npm install -g @bubblewrap/cli

      # 5. 初始化 TWA（无交互）
      - name: Bubblewrap Init
        run: |
          bubblewrap init \
            --manifest=https://你的域名或github.io/manifest.json \
            --nonInteractive \
            --useJdkFromPath

      # 6. 构建 + 签名 APK
      - name: Bubblewrap Build
        env:
          KEYSTORE_PATH: release.keystore
          KEYSTORE_PASSWORD: "810417"
          KEY_ALIAS: "powertech"
        run: |
          bubblewrap build \
            --nonInteractive \
            --useJdkFromPath \
            --keyStore=$KEYSTORE_PATH \
            --storePassword=$KEYSTORE_PASSWORD \
            --keyPassword=$KEYSTORE_PASSWORD \
            --key=$KEY_ALIAS

      # 7. 上传 APK 成果
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: twa-apk
          path: ./app-release-signed.apk
