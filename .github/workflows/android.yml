name: Build TWA APK (from PWA)

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main

env:
  CI: "1"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Bubblewrap CLI
        run: npm install -g @bubblewrap/cli

      # --- Restore keystore ---
      - name: Restore keystore (p12)
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "KEYSTORE_BASE64 secret is missing"; exit 1
          fi
          echo "$KEYSTORE_BASE64" | base64 --decode > upload-keystore.p12
          ls -lh upload-keystore.p12

      # --- Optional bump version script (only if file exists) ---
      - name: Bump version (optional)
        if: ${{ hashFiles('scripts/bump-version.sh') != '' }}
        run: |
          chmod +x scripts/bump-version.sh
          ./scripts/bump-version.sh

      # --- Bubblewrap init ---
      - name: Bubblewrap init (non-interactive)
        env:
          BUBBLEWRAP_NO_PROMPT: "true"
          BUBBLEWRAP_FORCE_NO_JDK: "true"
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          set -e
          bubblewrap init \
            --manifest=https://powertech0417.github.io/Cv_ap/manifest.json \
            --skipPwaDisplayModeCheck \
            --use-notification-delegation \
            --nonInteractive \
            --skipInstall \
            --signingKey=upload-keystore.p12 \
            --storePassword="$KEYSTORE_PASSWORD" \
            --keyAlias="$KEY_ALIAS" \
            --keyPassword="$KEY_PASSWORD" || echo "init skipped"

      # --- Build APK ---
      - name: Bubblewrap build (non-interactive)
        env:
          BUBBLEWRAP_NO_PROMPT: "true"
          BUBBLEWRAP_FORCE_NO_JDK: "true"
        run: |
          set -e
          bubblewrap build --nonInteractive --skipInstall || true
          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            ./gradlew assembleRelease --warning-mode all || true
          fi

      # --- Collect APK ---
      - name: Find generated APK(s)
        run: |
          find . -type f -name "*.apk" > apk_list.txt
          cat apk_list.txt

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: cv-app-apk
          path: |
            apk_list.txt
            **/*.apk
